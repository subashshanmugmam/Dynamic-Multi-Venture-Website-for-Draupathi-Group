name: Simple CI (No Database)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Frontend Job
  frontend:
    name: Frontend Build & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: './draupathi-frontend/package-lock.json'
    
    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: ./draupathi-frontend/node_modules
        key: ${{ runner.os }}-frontend-simple-${{ hashFiles('**/draupathi-frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-simple-
          ${{ runner.os }}-frontend-
    
    - name: Install dependencies
      working-directory: ./draupathi-frontend
      run: npm install --legacy-peer-deps
    
    - name: Lint code
      working-directory: ./draupathi-frontend
      run: npm run lint
    
    - name: Build application
      working-directory: ./draupathi-frontend
      run: npm run build
    
    - name: Check build size
      working-directory: ./draupathi-frontend
      run: |
        if [ -d "dist" ]; then
          echo "Build successful! Build size:"
          du -sh dist/
          ls -la dist/
        else
          echo "Build failed - no dist directory found"
          exit 1
        fi

  # Backend Job (No Database)
  backend:
    name: Backend Syntax & Build Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: './draupathi-backend/package-lock.json'
    
    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: ./draupathi-backend/node_modules
        key: ${{ runner.os }}-backend-simple-${{ hashFiles('**/draupathi-backend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-backend-simple-
          ${{ runner.os }}-backend-
    
    - name: Install dependencies
      working-directory: ./draupathi-backend
      run: npm install --legacy-peer-deps
    
    - name: Syntax validation
      working-directory: ./draupathi-backend
      run: |
        echo "üîç Running comprehensive syntax checks..."
        
        # Main server file
        if [ -f "src/server.js" ]; then
          echo "‚úÖ Checking src/server.js"
          node -c src/server.js
        fi
        
        # Controllers
        for file in src/controllers/*.js; do
          if [ -f "$file" ]; then
            echo "‚úÖ Checking $file"
            node -c "$file"
          fi
        done
        
        # Routes
        for file in src/routes/*.js; do
          if [ -f "$file" ]; then
            echo "‚úÖ Checking $file"
            node -c "$file"
          fi
        done
        
        # Models
        for file in src/models/*.js; do
          if [ -f "$file" ]; then
            echo "‚úÖ Checking $file"
            node -c "$file"
          fi
        done
        
        # Middleware
        for file in src/middleware/*.js; do
          if [ -f "$file" ]; then
            echo "‚úÖ Checking $file"
            node -c "$file"
          fi
        done
        
        # Utils
        for file in src/utils/*.js; do
          if [ -f "$file" ]; then
            echo "‚úÖ Checking $file"
            node -c "$file"
          fi
        done
        
        echo "üéâ All syntax checks passed!"
    
    - name: Test npm scripts
      working-directory: ./draupathi-backend
      run: |
        echo "üìã Available npm scripts:"
        npm run
        
        echo ""
        echo "üß™ Running basic test script:"
        npm test

  # Security audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Audit frontend dependencies
      run: |
        cd draupathi-frontend
        echo "üîí Frontend security audit:"
        npm audit --audit-level=high || true
    
    - name: Audit backend dependencies
      run: |
        cd draupathi-backend
        echo "üîí Backend security audit:"
        npm audit --audit-level=high || true
    
    - name: Check for known vulnerabilities
      run: |
        echo "‚úÖ Security audit completed"
        echo "Review any HIGH or CRITICAL vulnerabilities above"